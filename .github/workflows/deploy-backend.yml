name: Deploy Backend Mazzotini

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Executar comandos via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          # 1. Configurar o ambiente (Obrigat√≥rio para o rob√¥ achar node/yarn)
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          nvm use 22 || nvm install 22
          
          # Garante que o Yarn tamb√©m esteja no PATH
          export PATH="$PATH:$(yarn global bin):$HOME/.yarn/bin"

          # Interrompe o script se qualquer comando falhar
          set -e
          
          echo "üöÄ Iniciando Deploy na pasta /var/www/mazzotini-backend..."
          
          # 2. Acessar a pasta do projeto
          cd /var/www/mazzotini-backend

          # 3. Atualizar c√≥digo
          echo "‚¨áÔ∏è Fazendo git pull..."
          git fetch origin main
          git reset --hard origin/main
          
          # 4. Instalar depend√™ncias com limite de mem√≥ria
          echo "üì¶ Rodando yarn install..."
          export NODE_OPTIONS="--max-old-space-size=2048"
          yarn install 

          # 5. Sincronizar Banco de Dados (CR√çTICO para as suas mudan√ßas recentes)
          echo "üóÑÔ∏è Sincronizando banco de dados com Prisma..."
          yarn db:push
          
          # 5. Build
          echo "üèóÔ∏è Compilando projeto..."
          npx tsc --skipLibCheck --noEmitOnError false --outDir build || echo "Avisos ignorados, continuando..."   
                 
          # 6. Reiniciar servidor
          echo "üîÑ Reiniciando PM2..."
          pm2 restart /var/www/ecosystem.config.js
          
          echo "‚úÖ Deploy finalizado com sucesso!"