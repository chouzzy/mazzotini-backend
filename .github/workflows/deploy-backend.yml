name: Deploy Backend Mazzotini

on:
  push:
    branches:
      - main  # Dispara sempre que houver push na main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Executar comandos via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          # Para o script se der erro em qualquer linha
          set -e
          
          echo "ğŸš€ Iniciando Deploy Automatizado..."
          
          # 1. Acessar a pasta
          cd /var/www/mazzotini-backend
          
          # 2. Baixar atualizaÃ§Ãµes
          echo "â¬‡ï¸ Baixando cÃ³digo..."
          git pull origin main
          
            # 3. Instalar dependÃªncias (caso tenha adicionado lib nova)
            echo "ğŸ“¦ Instalando dependÃªncias..."
            export NODE_OPTIONS="--max-old-space-size=2048"
            yarn install --frozen-lockfile
          
          # 4. Atualizar o Prisma (CRÃTICO para as suas mudanÃ§as recentes)
          echo "ğŸ—„ï¸ Gerando cliente Prisma..."
          npx prisma generate
          
          # Opcional: Descomente abaixo se quiser que ele atualize o banco sozinho
          # echo "ğŸ—„ï¸ Atualizando estrutura do banco..."
          # npx prisma db push
          
          # 5. Build
          echo "ğŸ—ï¸ Compilando projeto..."
          yarn build
          
          # 6. Reiniciar servidor
          echo "ğŸ”„ Reiniciando PM2..."
          pm2 restart mazzotini-backend
          
          echo "âœ… Deploy finalizado com sucesso!"