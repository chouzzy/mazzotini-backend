name: Deploy Backend Mazzotini

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Executar comandos via SSH
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        port: 22
        script: |
          # 1. Configurar o ambiente (ObrigatÃ³rio para o robÃ´ achar node/yarn)
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
          nvm use 22 || nvm install 22
          
          # Garante que o Yarn tambÃ©m esteja no PATH
          export PATH="$PATH:$(yarn global bin):$HOME/.yarn/bin"

          # Interrompe o script se qualquer comando falhar
          set -e
          
          echo "ğŸš€ Iniciando Deploy na pasta /var/www/mazzotini-backend..."
          
          # 2. Acessar a pasta do projeto
          cd /var/www/mazzotini-backend

          # 3. Atualizar cÃ³digo
          echo "â¬‡ï¸ Fazendo git pull..."
          git fetch origin main
          git reset --hard origin/main
          
          # 4. Instalar dependÃªncias com limite de memÃ³ria
          echo "ğŸ“¦ Rodando yarn install..."
          export NODE_OPTIONS="--max-old-space-size=2048"
          yarn install 

          # 5. Sincronizar Banco de Dados (CRÃTICO para as suas mudanÃ§as recentes)
          echo "ğŸ—„ï¸ Sincronizando banco de dados com Prisma..."
          yarn db:push
          
          # 5. Build
          echo "ğŸ—ï¸ Compilando projeto..."
          yarn build
          
          # 6. Reiniciar servidor
          echo "ğŸ”„ Reiniciando PM2..."
          pm2 restart /var/www/ecosystem.config.js
          
          echo "âœ… Deploy finalizado com sucesso!"